<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Who Stole The Loaf? Powered By $BOWWW</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #6a0dad;
      text-align: center;
      color: white;
    }
    header img {
      width: 120px;
      margin: 20px 12px 0;
      vertical-align: middle;
    }
    h1 {
      margin: 0.6em 0 0.3em;
      font-size: 1.8em;
      padding: 0 12px;
    }
    .instructions, .join-box, .admin-panel {
      background-color: #ffd141;
      color: black;
      max-width: 700px;
      width: 90%;
      margin: 1.5em auto;
      padding: 1.5em;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }
    .button-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .button {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .connect { background-color: #8000c9; color: white; }
    .metamask { background-color: #ffffff; color: black; }
    .join { background-color: #eeeeee; color: black; }
    .status { margin: 10px auto; font-weight: bold; }
    .connected-address { color: black !important; }
    select {
      padding: 8px;
      border-radius: 6px;
      margin-top: 10px;
    }
    footer {
      margin-top: 2em;
    }
    footer a {
      color: #fff;
      text-decoration: none;
      margin: 0 10px;
      font-size: 0.9em;
    }
    #adminPanel { display: none; }
    @media (max-width: 480px) {
      .button-group { flex-direction: column; }
      header img { width: 90px; }
      h1 { font-size: 1.4em; }
    }
  </style>
</head>
<body>
<header>
  <img src="$BOWWW.PNG" alt="$BOWWW Logo" />
  <img src="matic.PNG" alt="Matic Logo" />
</header>
<main>
  <h1>Who Stole The Loaf? Powered By $BOWWW</h1>
  <p>Join the regional war for bread. Pay 3.69 MATIC. Earn $BOWWW.</p>
  <div class="instructions">
    <strong>How to Join:</strong>
    <ul>
      <li>Connect wallet</li>
      <li>Select a bread-themed region</li>
      <li>Pay 3.69 MATIC</li>
      <li>Receive 1107 $BOWWW and lock in your region</li>
    </ul>
  </div>
  <div class="join-box">
    <div class="button-group">
      <button id="connectWalletBtn" class="button connect">Connect Wallet</button>
      <a href="https://metamask.app.link/dapp/breadoftheinternet.github.io/Whostoletheloaf/" class="button metamask">Open in MetaMask</a>
    </div>
    <div class="status">Connected: <span id="walletStatus" class="connected-address">Not connected</span></div>
    <select id="regionSelect">
      <option value="Sourdough Region">Sourdough Region</option>
      <option value="Wheat Region">Wheat Region</option>
      <option value="White Region">White Region</option>
      <option value="Brioche Region">Brioche Region</option>
      <option value="Pita Region">Pita Region</option>
      <option value="Rye Region">Rye Region</option>
      <option value="Cornbread Region">Cornbread Region</option>
    </select>
    <button id="joinBtn" class="button join" disabled>Join for 3.69 MATIC</button>
  </div>

  <div id="standingsBox" class="join-box">Weekly Region Standings<br/>Loading...</div>

  <div id="adminPanel" class="admin-panel">
    <strong>Admin Reward Distribution Panel</strong>
    <p>Select a region to distribute the weekly reward.</p>
    <select id="adminRegionSelect">
      <option value="">-- Select Region --</option>
      <option value="Sourdough Region">Sourdough Region</option>
      <option value="Wheat Region">Wheat Region</option>
      <option value="White Region">White Region</option>
      <option value="Brioche Region">Brioche Region</option>
      <option value="Pita Region">Pita Region</option>
      <option value="Rye Region">Rye Region</option>
      <option value="Cornbread Region">Cornbread Region</option>
    </select>
    <br/><br/>
    <button id="distributeBtn" class="button join">Distribute Reward</button>
    <button id="burnBtn" class="button connect">Burn + Rollover</button>
  </div>

  <footer>
    <a href="https://polygonscan.com/token/0x284414b6777872E6DD8982394Fed1779dc87a3Cf#code">$BOWWW Token</a> |
    <a href="https://polygonscan.com/address/0x403C73A921FB11375816d4F035FC1711229F2b7F">Game Contract</a> |
    <a href="https://linktr.ee/breadoftheinternet">More Info</a>
  </footer>
</main>

<script>
const CONTRACT_ADDRESS = "0x403C73A921FB11375816d4F035FC1711229F2b7F";
const ADMIN_ADDRESS = "0x40726Dbe406b8B79c88c0fa45D3caA8e3574D7b6";

const CONTRACT_ABI = [
  "function joinGame(string region) payable",
  "function getRegions() view returns (string[] memory)",
  "function getHolderCount(string region) view returns (uint256)",
  "function getWeeklyThreshold(uint256) view returns (uint256)",
  "function distributeReward(string,uint256)"
];

let provider, signer, userAddress = "";

async function connectWallet() {
  if (window.ethereum) {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    document.getElementById("walletStatus").textContent = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
    document.getElementById("walletStatus").style.color = "black";
    document.getElementById("joinBtn").disabled = false;
    if (userAddress.toLowerCase() === ADMIN_ADDRESS.toLowerCase()) {
      document.getElementById("adminPanel").style.display = "block";
    }
    await loadRegionStandings();
  } else {
    alert("Please install MetaMask.");
  }
}

async function loadRegionStandings() {
  const standingsDiv = document.getElementById("standingsBox");
  standingsDiv.innerHTML = "Loading...";
  try {
    if (!provider) {
      standingsDiv.innerHTML = "Please connect wallet to view standings.";
      return;
    }
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
    const regions = await contract.getRegions();
    const threshold = await contract.getWeeklyThreshold(1);
    let html = `<strong>Weekly Region Standings (Active Week: 1)</strong><table style='margin:auto;text-align:left;background:white;color:black;border-radius:12px;padding:12px;font-size:14px;'><tr><th>Region</th><th>Holders</th><th>Status</th></tr>`;
    for (const region of regions) {
      const count = await contract.getHolderCount(region);
      const met = count >= threshold ? "✅ Met" : "❌ Not Met";
      html += `<tr><td>${region}</td><td>${count}</td><td>${met}</td></tr>`;
    }
    html += `</table>`;
    standingsDiv.innerHTML = html;
  } catch (err) {
    standingsDiv.innerHTML = "Failed to load standings.";
    console.error(err);
  }
}

document.getElementById("connectWalletBtn").onclick = connectWallet;

document.getElementById("joinBtn").onclick = async () => {
  const region = document.getElementById("regionSelect").value;
  const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  try {
    const tx = await contract.joinGame(region, {
      value: ethers.utils.parseEther("3.69")
    });
    await tx.wait();
    alert(`Joined ${region}! TX: https://polygonscan.com/tx/${tx.hash}`);
    loadRegionStandings();
  } catch (e) {
    alert("Transaction failed: " + e.message);
  }
};

document.getElementById("distributeBtn").onclick = async () => {
  const region = document.getElementById("adminRegionSelect").value;
  if (!region) return alert("Please select a region");
  const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  try {
    const tx = await contract.distributeReward(region, 1);
    await tx.wait();
    alert("Rewards distributed successfully!");
    loadRegionStandings();
  } catch (e) {
    alert("Distribution failed: " + e.message);
  }
};

document.getElementById("burnBtn").onclick = () => {
  alert("Burn + Rollover will be implemented in final contract deployment.");
};

window.addEventListener("load", () => {
  document.getElementById("standingsBox").innerHTML = "Please connect wallet to view standings.";
});
</script>
</body>
</html>





